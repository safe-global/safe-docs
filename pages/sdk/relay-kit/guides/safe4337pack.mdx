import { Tabs, Steps, Callout } from 'nextra/components'

# Bundling user operations with the Safe4337Pack

In this guide, you will learn how to create and use Safe accounts with the [Safe ERC-4337 compatible module](https://github.com/safe-global/safe-modules/tree/main/modules/4337/contracts/Safe4337Module.sol) via the `safe-core-sdk`.

This guide explores the construction of user operations and the underlying processes when a Safe is set up and deployed with the `Safe4337Module` enabled.

The 4337 package resides within the `relay-kit` package, as it relays transactions to a bundler.

In this guide, we will use Pimlico as the service provider. However, this is entirely optional, and you can choose any other provider that supports bundling and/or paymaster services.

## Prerequisites

Read the [4337 reference](../../../home/4337-safe) to understand the Safe 4337 Module architecture and its benefits.

- [Node.js and npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm).
- A [Pimlico account](https://dashboard.pimlico.io) and an API key.

## Steps

<Steps>

### Install dependencies

Install the `relay-kit` package:

```bash
yarn add ethers @safe-global/protocol-kit @safe-global/relay-kit@alpha
```

### Imports

Here are all the necessary imports for the script we are coding in this guide.

```typescript
import { ethers } from 'ethers'
import { EthersAdapter } from '@safe-global/protocol-kit'
import { Safe4337Pack } from '@safe-global/relay-kit'
```

### Create a signer

As a first step, we need a signer instance, which will become the owner of the Safe account after deployment. We use the `EthersAdapter` from the `protocol-kit` package to represent and create the signer from a private key. This `protocol-kit` instance is linked to the signer and used for signing user operations.

<Callout type="info" emoji="ℹ️">
  We are using the private key here but you can use any other method to create a
  [signer](https://docs.ethers.org/v6/api/providers/#Signer) instance.
</Callout>

```typescript
const PRIVATE_KEY = '0x...'

const provider = new ethers.JsonRpcProvider('https://rpc.ankr.com/eth_sepolia')
const signer = new ethers.Wallet(PRIVATE_KEY, provider)
const ethersAdapter = new EthersAdapter({
  ethers,
  signerOrProvider: signer
})
```

### Initialize `Safe4337Pack`

To create an instance of the `Safe4337Pack`, use the static `init()` method. You can link an existing Safe account (with the `Safe4337Module` deployed) or set a custom configuration to deploy the Safe account concurrently with the transaction execution. When deploying a new Safe the `Safe4337Module` is enabled automatically as part of the deployment.

{/* <!-- vale off --> */}

<Tabs items={['new-safe.ts','existing-safe.ts']}>
  <Tabs.Tab>
    ```typescript
    // Create a new Safe account. Set up owners and threshold
    const safe4337Pack = await Safe4337Pack.init({
      ethersAdapter,
      rpcUrl: 'https://rpc.ankr.com/eth_sepolia',
      bundlerUrl: `https://api.pimlico.io/v1/sepolia/rpc?apikey=${PIMLICO_API_KEY}`,
      options: {
        owners: [await signer.getAddress()],
        threshold: 1
      }
    })
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Use an existing Safe account
    const safe4337Pack = await Safe4337Pack.init({
      ethersAdapter,
      rpcUrl: 'https://rpc.ankr.com/eth_sepolia',
      bundlerUrl: `https://api.pimlico.io/v1/sepolia/rpc?apikey=${PIMLICO_API_KEY}`,
      options: {
        safeAddress: '0x...'
      }
    })
    ```
    </Tabs.Tab>
</Tabs>

{/* <!-- vale on --> */}

### Create the transaction

Generate a transaction using the `createTransaction()` method. This method takes an array of transaction objects, which will use the Safe multisend contract to encode a batch of transactions.

```typescript
// Create some transactions
const transaction1 = { to, data, value }
const transaction2 = { to, data, value }

const transactions = [transaction1, transaction2]

// Create the transaction batch bundled in a SafeOperation object
const safeOperation = await safe4337Pack.createTransaction({ transactions })
```

Calling the `createTransaction()` method returns a `SafeOperation` object, which contains transaction batch data encoded by the Safe multisend contract. If the Safe account doesn't exist, the `initCode` field of the user operation will hold the Safe account creation bytecode ready to be sent to the bundler. As the bundler processes the user operation, this code is used to deploy the Safe account before executing the transaction batch.

### Sign the SafeOperation

Before sending it to the bundler, it's essential to sign the `SafeOperation` with the signer associated to the `EthersAdapter` instance. This generates a signature that will authorize the execution of the transaction batch.

```typescript
const signedSafeOperation = await safe4337Pack.signSafeOperation(safeOperation)
```

### Execute the transaction

Finally, once the `SafeOperation` is signed, you can forward the underlying user operation to the bundler.

```typescript
const userOperationHash = await safe4337Pack.executeTransaction({
  executable: signedSafeOperation
})
```

The `executeTransaction()` method will return the hash of the user operation sent to the bundler. This allows you to monitor the transaction's status using a block explorer or the bundler's API.

### Check the transaction execution status

To check the transaction status, you can use the `getTransactionReceipt()` method. This method returns the transaction receipt once the transaction is mined, allowing you to wait until the receipt object is present.

```typescript
let userOperationReceipt = null

while (!userOperationReceipt) {
  // Wait 2 seconds before checking the status again
  await new Promise((resolve) => setTimeout(resolve, 2000))
  userOperationReceipt = await safe4337Pack.getUserOperationReceipt(
    userOperationHash
  )
}
```

In addition, you can use the `getUserOperationByHash()` method with the returned hash to retrieve the user operation object you sent to the bundler.

```typescript
const userOperationPayload = await safe4337Pack.getUserOperationByHash(
  userOperationHash
)
```

</Steps>

## Recap and further reading

This guide explains using the `Safe4337Pack` and how this simplifies the process of creating and executing transactions in a batch with non existing Safe accounts. The process includes creating a Safe account with the enabled `Safe4337Module` ready for relaying transactions to a chosen bundler provider.

Learn more about the ERC-4337 standard and the `Safe4337Module` contract at these links:

- [ERC-4337 Website](https://www.erc4337.io)
- [EIP-4337 on Ethereum EIPS](https://eips.ethereum.org/EIPS/eip-4337)
- [Safe 4337 Module on GitHub](https://github.com/safe-global/safe-modules/tree/main/modules/4337)
