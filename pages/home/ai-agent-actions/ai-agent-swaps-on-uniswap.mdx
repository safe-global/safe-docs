import { Steps } from 'nextra/components'

# AI agent swaps on Uniswap

You can find a working code example to run locally in our [example repository](https://github.com/5afe/safe-uniswap-example).

Here is a quick guide to get you up and running:

## Swap on Uniswap

<Steps>

### Fetch Uniswap pool data

First, you have to fetch the pool data from Uniswap. 
This data provides information about the liquidity at the current and at other prices.

```typescript
const fetchPoolData = async (
  publicClient: PublicClient,
  poolAddress: Address
) => {
  // Fetch slot0 data (current price, tick, etc.)
  const slot0 = (await publicClient.readContract({
    address: poolAddress,
    abi: POOL_ABI,
    functionName: "slot0",
  })) as any;

  // Fetch liquidity
  const liquidity = (await publicClient.readContract({
    address: poolAddress,
    abi: POOL_ABI,
    functionName: "liquidity",
  })) as any;

  const sqrtPriceX96 = BigInt(slot0[0]);
  const tick = slot0[1];

  return { sqrtPriceX96, tick, liquidity: BigInt(liquidity) };
};
```

### Execute Swap

Now, you can setup your Safe Smart Account and send a swap transaction to Uniswap:

```typescript
// Destructure environment variables
const { SAFE_ADDRESS, SIGNER_PRIVATE_KEY, RPC_URL } = process.env;

// Check if all required environment variables are present
if (!SAFE_ADDRESS || !SIGNER_PRIVATE_KEY || !RPC_URL) {
    throw new Error("Missing environment variables in .env file");
}

const customChain = defineChain({
    ...mainnet,
    name: "custom chain",
    transport: http(RPC_URL),
});

const account = privateKeyToAccount(SIGNER_PRIVATE_KEY as `0x${string}`);

// Set up viem clients and accounts
const publicClient = createPublicClient({
    transport: http(RPC_URL!),
    chain: customChain,
});
const walletClient = createWalletClient({
    transport: http(RPC_URL!),
    chain: customChain,
});

const protocolKit = await Safe.init({
    provider: RPC_URL,
    signer: SIGNER_PRIVATE_KEY,
    safeAddress: SAFE_ADDRESS,
});

const isSafeDeployed = await protocolKit.isSafeDeployed(); // True

if (!isSafeDeployed) {
    throw new Error("Safe not deployed");
}

const chainId = (await publicClient.getChainId());

const WETH_ADDRESS = "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2";
const USDC_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";
const USDC_ETH_POOL_ADDRESS = "0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640";
const SWAP_ROUTER_ADDRESS = "0xE592427A0AEce92De3Edee1F18E0157C05861564"; // Uniswap V3 Router
const INPUT_AMOUNT = "100000000000"; // Amount of ETH to swap to USDC
const OUTOUT_AMOUNT = "0"; // 0 USDC

// Define token details
const USDC = new Token(chainId, USDC_ADDRESS, 6, "USDC", "USD Coin");
const WETH = new Token(chainId, WETH_ADDRESS, 18, "WETH", "Wrapped Ether");

const callDataDeposit = encodeFunctionData({
    abi: WETH_ABI,
    functionName: "deposit",
    args: [],
});

// Exchange ETH to WETH
const safeDepositTx: MetaTransactionData = {
    to: WETH_ADDRESS,
    value: INPUT_AMOUNT,
    data: callDataDeposit,
    operation: OperationType.Call,
};

const callDataApprove = encodeFunctionData({
    abi: WETH_ABI,
    functionName: "approve",
    args: [SWAP_ROUTER_ADDRESS, INPUT_AMOUNT],
});

const safeApproveTx: MetaTransactionData = {
    to: WETH_ADDRESS,
    value: "0",
    data: callDataApprove,
    operation: OperationType.Call,
};

const options: SwapOptions = {
    slippageTolerance: new Percent(50, 10_000), // 50 bips, or 0.50%
    deadline: Math.floor(Date.now() / 1000) + 60 * 20, // 20 minutes from the current Unix time
    recipient: SAFE_ADDRESS,
};

const poolInfo = await fetchPoolData(publicClient, USDC_ETH_POOL_ADDRESS);

// Create the pool object
const pool = new Pool(
    WETH,
    USDC,
    FeeAmount.MEDIUM,
    JSBI.BigInt(poolInfo.sqrtPriceX96.toString()),
    JSBI.BigInt(poolInfo.liquidity.toString()),
    poolInfo.tick
);

const swapRoute = new Route([pool], WETH, USDC);

const uncheckedTrade = Trade.createUncheckedTrade({
    tradeType: TradeType.EXACT_INPUT,
    route: swapRoute,
    inputAmount: CurrencyAmount.fromRawAmount(WETH, 
        INPUT_AMOUNT
    ),
    outputAmount: CurrencyAmount.fromRawAmount(USDC, OUTOUT_AMOUNT),
});

const methodParameters = SwapRouter.swapCallParameters(
    [uncheckedTrade],
    options
);

const safeSwapTx: MetaTransactionData = {
    to: SWAP_ROUTER_ADDRESS,
    value: methodParameters.value,
    data: methodParameters.calldata,
    operation: OperationType.Call,
};

console.log(`ETH balance before: ${await publicClient.getBalance({address: SAFE_ADDRESS as `0x${string}`})}`);

const wethBalanceBefore = await publicClient.readContract({
    abi: ERC20_ABI,
    address: WETH_ADDRESS,
    functionName: "balanceOf",
    args: [SAFE_ADDRESS],
});

console.log("WETH balance before: ", wethBalanceBefore);

const usdcBalanceBefore = await publicClient.readContract({
    abi: ERC20_ABI,
    address: USDC_ADDRESS,
    functionName: "balanceOf",
    args: [SAFE_ADDRESS],
});

console.log("USDC balance before: ", usdcBalanceBefore);

const safeTx = await protocolKit.createTransaction({
    transactions: [safeDepositTx, safeApproveTx, safeSwapTx],
    onlyCalls: true,
});

const txResponse = await protocolKit.executeTransaction(safeTx);
    await publicClient.waitForTransactionReceipt({
    hash: txResponse.hash as `0x${string}`,
});

console.log(`Deposit and approve transaction: [${txResponse.hash}]`);

console.log(`ETH balance after: ${await publicClient.getBalance({address: SAFE_ADDRESS as `0x${string}`})}`);

const wethBalanceAfter = await publicClient.readContract({
    abi: ERC20_ABI,
    address: WETH_ADDRESS,
    functionName: "balanceOf",
    args: [SAFE_ADDRESS],
});

console.log("WETH balance after: ", wethBalanceAfter);

const usdcBalanceAfter = await publicClient.readContract({
    abi: ERC20_ABI,
    address: USDC_ADDRESS,
    functionName: "balanceOf",
    args: [SAFE_ADDRESS],
});

console.log("USDC balance after: ", usdcBalanceAfter);
```

Now your AI agent executed a swap on Uniswap.

</Steps>

## Next steps

You can find more information about Swaps on Uniswap in their [docs about swaps](https://docs.uniswap.org/contracts/v4/quickstart/swap).

If you have a technical question about Safe Smart Accounts, feel free to reach out on [Stack Exchange](https://ethereum.stackexchange.com/questions/tagged/safe-core) with the safe-core tag.