import { Callout, Steps, Tabs } from 'nextra/components'

# Safe stack installation guide

## Safe\{Core\} contracts deployment

In the first step, you will deploy the Safe\{Core\} contracts on your chain.

All Safe contract deployments on any network follow the same procedure to ensure a deterministic address for all singleton contracts (proxy-factory, mastercopy, etc.) and verify the deployment.

### Prerequisites

Open a [pull request](https://github.com/ethereum-lists/chains) to add your chain to [chainlist.org](https://chainlist.org/).

### Steps

<Steps>

### Singleton factory contract deployment

<Callout type="info" emoji="ℹ️">
 You do not need to perform these tasks if your network is based on a rollup framework with Safe contracts already deployed (for example, OP Stack).
</Callout>

1. Create a new issue in the [safe-singleton-factory](https://github.com/safe-global/safe-singleton-factory/issues/new?assignees=&labels=&projects=&template=new_chain.yml&title=%5BNew+chain%5D%3A+) repository.
2. A bot will reply to the issue with the deployer address (`0x914...3d7`) and the amount of native token you need to send to this address.
3. Once funded, mark the checkbox on the GitHub issue.
4. The review of the issues happens every two weeks. Our team will perform the deterministic deployment of the `safe-singleton-factory` contract and publish a new npm release of [@safe-global/safe-singleton-factory](https://www.npmjs.com/package/@safe-global/safe-singleton-factory).

### Singleton contracts deployment 

<Callout type="info" emoji="ℹ️">
 You do not need to perform these tasks if your network is based on a rollup framework with Safe contracts already deployed (for example, OP Stack).
</Callout>

1. Clone the [safe-smart-account](https://github.com/safe-global/safe-smart-account) repository by running the following command:
    ```
    git clone --branch v1.3.0-libs.0 https://github.com/safe-global/safe-smart-account.git
    ```
    
2. Get the latest version of [@safe-global/safe-singleton-factory](https://www.npmjs.com/package/@safe-global/safe-singleton-factory), by running the following command:

    ```bash
    npm i --save-dev @safe-global/safe-singleton-factory
    ```

    Ensure the latest version includes your `safe-singleton-factory` deployment from the earlier section.

3. Deploy Contracts.
    
    <Tabs items={["Infura supports your chain", "Infura does not support your chain"]}>
        <Tabs.Tab>
            Create a `.env` file in the root of the repository with the following content:
            ```bash
            MNEMONIC=funded_account_on_this_network
            INFURA_KEY=your_Infura_project_API_key
            ```

            Deploy the contracts by running this command:
            ```bash
            npm run deploy-all your_chain_id
            ```
        </Tabs.Tab>
        <Tabs.Tab>
            Create a `.env` file in the root of the repository with the following content:
            ```bash
            MNEMONIC=funded_account_on_this_network
            NODE_URL=RPC_endpoint_for_your_network
            ```

            Deploy the contracts by running this command:

            ```bash
            npm run deploy-all custom
            ```
        </Tabs.Tab>
    </Tabs>

4. The script should deploy all the singleton contracts (nine contracts in total).

    Write down each address (example addresses for v1.3.0 could look like):
    ```js
    compatibility_fallback_handler: `0x017062a1dE2FE6b99BE3d9d37841FeD19F573804`
    create_call: `0xB19D6FFc2182150F8Eb585b79D4ABcd7C5640A9d`
    gnosis_safe: `0x69f4D1788e39c87893C980c06EdF4b7f686e2938`
    gnosis_safe_l2: `0xfb1bffC9d739B8D520DaF37dF666da4C687191EA`
    multi_send: `0x998739BFdAAdde7C933B942a68053933098f9EDa`
    multi_send_call_only: `0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B`
    proxy_factory: `0xC22834581EbC8527d974F8a1c97E1bEA4EF910BC`
    sign_message_lib: `0x98FFBBF51bb33A056B08ddf711f289936AafF717`
    simulate_tx_accessor: `0x727a77a074D1E6c4530e814F89E618a3298FC044`
    ```


### Record your contracts in the official registry

You must share your singleton contract deployment addresses in the official public registry.
1. Fork the [safe-deployments](https://github.com/safe-global/safe-deployments) GitHub repository.
2. Add your chain ID to each of the nine JSON files in `src/assets/<version>`. If you deployed with the singleton deployment from above, you have to mark your chain's deployment as "canonical".
For example, add this line to `gnosis_safe.json` to indicate the gnosis safe has the canonical address on your chain:
    ```json
    "<your_chain_id>": "canonical"
    ```

3. Open a pull request. Your pull request should follow this [example pull request](https://github.com/safe-global/safe-deployments/pull/679).

</Steps>

## Safe\{Core\} Infrastructure deployment

Once you have deployed the Safe\{Core\} contracts, you must deploy the off-chain components of the Safe\{Core\} Stack, including backend and frontend services. 

You have three options for deploying the Safe stack, depending on your needs.

### Option 1: Safe Core Contributor Platform-as-a-Service

We roll out new networks quarterly, depending on our internal capacity, and only for medium to large chains based on a strict scoring framework. 

If you want to submit your chain for assessment in the next quarter, please fill out this [form](https://noteforms.com/forms/request-safe-ui-and-infra-support-4weugt).

#### Hard requirements

- EVM-compatible chain.
- At least two dedicated RPC node providers, with preference for at least one Tier 1 provider of Infura, Alchemy, Quicknode. You can find more on RPC nodes [here](https://docs.safe.global/core-api/api-safe-transaction-service/rpc-requirements).

### Option 2: Third-party integrators

We are happy to introduce you to our official integrators.

List of official integrators:

    - integrator A | website | telegram | twitter
    - integrator B | website | telegram | twitter
    - integrator C | website | telegram | twitter

### Option 3: Self-hosting

If you have engineering and Cloud resources, you can also deploy the different components of the Stack by following one of the procedures below. 

You can find docker images for a majority of platforms. 

#### Requirements

**Hardware**

These are the hardware requirements to run the different services required.


| Network | Transaction Service | Client Gateway | Config Service | Database |
| --- | --- | --- | --- | --- |
| Small (new chain with low traffic) | CPU: 2 vCPU RAM: 8GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 1 cores/ 2 vCPU RAM: 8GiB |
| Standard | CPU: 4 vCPU RAM: 16GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 2 cores/ 4 vCPU RAM: 16GiB |
| Large (large chain with high-traffic) | CPU: 8 vCPU RAM: 32GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 2 vCPU RAM: 8 GiB | CPU: 8 cores/ 16 vCPU RAM: 64GiB |


**RPC**

For support, please refer to the [RPC requirements](https://docs.safe.global/core-api/api-safe-transaction-service/rpc-requirements#what-are-the-rpc-requirements). Safe (L1) requires tracing for indexing, while Safe (L2) supports events/logs.

#### Docker-compose deployment

Please see the [safe-infrastructure](https://github.com/safe-global/safe-infrastructure) repository for all required information.

```bash
git clone git@github.com:safe-global/safe-infrastructure.git
cd safe-infrastructure
```

**Prerequisites**

- Docker v20.10+
- Docker-compose 2.x.x+
- Running Ethereum JSON RPC client

**Configuration**

```bash
cp .env.sample .env
vi .env
REVERSE_PROXY_PORT=8000
CFG_VERSION=latest
CGW_VERSION=latest
TXS_VERSION=latest
UI_VERSION=latest
EVENTS_VERSION=latest
RPC_NODE_URL=<REPLACE BY YOUR RPC ENDPOINT>
```

**Run**

This command runs seventeen Docker containers from the [docker-compose.yml](https://github.com/gjeanmart/safe-infrastructure/blob/main/docker-compose.yml):
- Nginx reverse proxy
- Postgres 14.x database (x3 for Transaction Service, Config Service, and Events Service)
- Redis database (x2 for Transaction Service and Client Gateway)
- RabbitMQ message queue (x2 for Transaction Service and General)
- Transaction Service (txs) workers & scheduler (x4)
- Transaction Service (txs) web
- Config Service (cfg) web
- Client Gateway (cgx) web
- Events service (events) web
- Wallet (ui) web

```bash
sh scripts/run_locally.sh
# will ask to set up username/password for config-service and transactions-service
```

**Local Ganache node**

You can optionally use a local Ganache node (including Safe's singleton contracts) for testing purposes:

```bash
vi .env
REVERSE_PROXY_PORT=8000
CFG_VERSION=latest
CGW_VERSION=latest
TXS_VERSION=latest
UI_VERSION=latest
EVENTS_VERSION=latest
CHAIN_ID=1337 # we recommend using 1337 to ensure compatibility with official deployments
RPC_NODE_URL=http://node:8545
MNEMONIC="test test test test test test test test test test test junk" # used to deploy singleton contracts

sh ./scripts/run_locally.sh -f docker-compose.local.yml
```

#### Kubernetes deployment

An official helm chart creates all the necessary manifests, including the service account and RBAC entities needed for service discovery.

```bash
helm repo add safe https://safe/safe/safe
helm repo update
helm install <RELEASE_NAME> safe/stack -f values.yaml [-n <NAMESPACE>]
```

The helm chart allows you to inline all the configurations directly in your `values.yaml`:

```bash
TO BE COMPLETED
```


#### Troubleshoot

- **Frontend endpoint returns `502 Bad Gateway`**: NextJS can take from five to ten minutes to generate all the pages and check the UI logs to ensure the process finished successfully.
    
    ```bash
    INFO  Accepting connections at [http://localhost:8080](http://localhost:8080/)
    ```
